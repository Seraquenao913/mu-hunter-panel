<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>WebZen Cache - Painel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <!-- Header -->
    <header class="mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">WebZen Cache</h1>
        <p class="text-sm text-slate-400">Painel de contas &amp; cache + seção de recentes</p>
      </div>
      <!-- Placeholder de status / usuário -->
      <div class="text-right text-xs text-slate-400">
        <span id="auth-status">autenticado via Supabase</span>
      </div>
    </header>

    <!-- Tabs -->
    <div class="border-b border-slate-700 mb-4">
      <nav class="-mb-px flex space-x-4 text-sm" aria-label="Tabs">
        <button
          id="tab-contas"
          class="border-b-2 border-sky-500 px-3 py-2 font-medium text-sky-400"
          data-tab-target="section-contas"
        >
          Contas
        </button>
        <button
          id="tab-recentes"
          class="border-b-2 border-transparent px-3 py-2 font-medium text-slate-400 hover:text-slate-200"
          data-tab-target="section-recentes"
        >
          Recentes
        </button>
      </nav>
    </div>

    <!-- SEÇÃO CONTAS (placeholder para seu layout atual) -->
    <section id="section-contas" class="space-y-4">
      <!-- Aqui você pode colar o restante do seu front atual (pesquisa, url/login/senha etc.).
           Mantive algo bem simples apenas pra não quebrar. -->
      <div class="bg-slate-800/70 border border-slate-700 rounded-2xl p-4">
        <h2 class="text-base font-semibold mb-2">Pesquisa / Cadastro de Contas</h2>
        <p class="text-xs text-slate-400 mb-4">
          Substitua este bloco pelo layout que você já tinha para pesquisa, URL/Login/Senha etc.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
          <div class="flex flex-col space-y-1">
            <label for="url" class="text-slate-300">URL</label>
            <input
              id="url"
              type="text"
              class="bg-slate-900/70 border border-slate-700 rounded-lg px-2 py-1.5 text-xs outline-none focus:ring-1 focus:ring-sky-500"
              placeholder="https://..."
            />
          </div>

          <div class="flex flex-col space-y-1">
            <label for="login" class="text-slate-300">Login</label>
            <input
              id="login"
              type="text"
              class="bg-slate-900/70 border border-slate-700 rounded-lg px-2 py-1.5 text-xs outline-none focus:ring-1 focus:ring-sky-500"
              placeholder="user@example.com"
            />
          </div>

          <div class="flex flex-col space-y-1">
            <label for="senha" class="text-slate-300">Senha</label>
            <input
              id="senha"
              type="text"
              class="bg-slate-900/70 border border-slate-700 rounded-lg px-2 py-1.5 text-xs outline-none focus:ring-1 focus:ring-sky-500"
              placeholder="********"
            />
          </div>
        </div>

        <div class="mt-4 flex flex-wrap items-center gap-2 text-xs">
          <button
            class="inline-flex items-center rounded-lg border border-sky-500 px-3 py-1.5 text-xs font-medium text-sky-100 hover:bg-sky-500/10"
          >
            Salvar / Atualizar
          </button>
          <button
            class="inline-flex items-center rounded-lg border border-slate-600 px-3 py-1.5 text-xs font-medium text-slate-100 hover:bg-slate-600/40"
          >
            Limpar
          </button>
        </div>
      </div>
    </section>

    <!-- SEÇÃO RECENTES -->
    <section id="section-recentes" class="space-y-4 hidden">
      <div class="flex items-center justify-between gap-2">
        <h2 class="text-base font-semibold">Recentes</h2>
        <div class="text-[11px] text-slate-400">
          Ordenado por <span class="font-semibold">updated_at DESC, inserted_at DESC</span>
        </div>
      </div>

      <!-- Filtros / opções -->
      <div class="flex flex-wrap items-center gap-3 text-xs">
        <div class="flex items-center gap-2">
          <label for="recentes-page-size" class="text-slate-300">Por página:</label>
          <select
            id="recentes-page-size"
            class="bg-slate-900/70 border border-slate-700 rounded-lg px-2 py-1 text-xs"
          >
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
        </div>
      </div>

      <!-- Card com tabela de recentes -->
      <div class="bg-slate-800/70 border border-slate-700 rounded-2xl p-3 text-xs">
        <!-- Header / legend -->
        <div class="flex items-center justify-between mb-3">
          <p class="text-[11px] text-slate-400">
            Exibindo últimas inserções/atualizações da tabela
            <span class="font-mono text-slate-200">public.webzen_cache_raw</span>
          </p>
          <span id="recentes-total" class="text-[11px] text-slate-400">0 registros</span>
        </div>

        <!-- Tabela enxuta -->
        <div class="overflow-x-auto">
          <table class="min-w-full text-left align-middle">
            <thead class="border-b border-slate-700 text-[11px] uppercase tracking-wide text-slate-400">
              <tr>
                <th class="py-1.5 pr-3">raw_line</th>
                <th class="py-1.5 px-3">TAG (tag4)</th>
                <th class="py-1.5 px-3 text-center">Flag</th>
                <th class="py-1.5 px-3 text-center">Online</th>
                <th class="py-1.5 px-3">Olhar</th>
                <th class="py-1.5 px-3 whitespace-nowrap">Atualizado</th>
              </tr>
            </thead>
            <tbody id="recentes-tbody" class="divide-y divide-slate-800">
              <!-- Linhas inseridas via JS -->
            </tbody>
          </table>
        </div>

        <!-- Footer / paginação -->
        <div class="mt-3 flex items-center justify-between text-[11px] text-slate-400">
          <div id="recentes-range"></div>
          <div class="flex items-center gap-2">
            <button
              id="recentes-prev"
              class="px-2 py-1 rounded border border-slate-600 disabled:opacity-40 disabled:cursor-not-allowed"
            >
              &larr; Anterior
            </button>
            <span id="recentes-page-indicator">Página 1</span>
            <button
              id="recentes-next"
              class="px-2 py-1 rounded border border-slate-600 disabled:opacity-40 disabled:cursor-not-allowed"
            >
              Próxima &rarr;
            </button>
          </div>
        </div>

        <!-- Estado -->
        <div id="recentes-status" class="mt-2 text-[11px] text-slate-500"></div>
      </div>
    </section>
  </div>

  <!-- Supabase & Lógica -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/esm/supabase.js";

    // TODO: troque pelos dados reais do seu projeto
    const supabaseUrl = "https://uwcyvobwgcdyyphafofy.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV3Y3l2b2J3Z2NkeXlwaGFmb2Z5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MDIyMzQsImV4cCI6MjA3NzE3ODIzNH0.YTDIIZ5AzwyhDASO15vexglhvTX4ZMqoZksZh3PPEH8";
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Controle de tabs
    const tabButtons = document.querySelectorAll("[data-tab-target]");
    const sections = {
      "section-contas": document.getElementById("section-contas"),
      "section-recentes": document.getElementById("section-recentes"),
    };

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-tab-target");

        // classes de estilo
        tabButtons.forEach((b) => {
          if (b === btn) {
            b.classList.remove("border-transparent", "text-slate-400");
            b.classList.add("border-sky-500", "text-sky-400");
          } else {
            b.classList.add("border-transparent", "text-slate-400");
            b.classList.remove("border-sky-500", "text-sky-400");
          }
        });

        Object.entries(sections).forEach(([id, sec]) => {
          if (id === target) {
            sec.classList.remove("hidden");
          } else {
            sec.classList.add("hidden");
          }
        });

        // Se trocar para "Recentes", recarrega
        if (target === "section-recentes") {
          loadRecentes(true);
        }
      });
    });

    // Paginação (Recentes)
    let recentesPage = 1;
    let recentesPageSize = 20;
    let recentesTotal = 0;

    const recentesPageSizeSelect = document.getElementById("recentes-page-size");
    const recentesPrevBtn = document.getElementById("recentes-prev");
    const recentesNextBtn = document.getElementById("recentes-next");
    const recentesTbody = document.getElementById("recentes-tbody");
    const recentesTotalSpan = document.getElementById("recentes-total");
    const recentesRangeSpan = document.getElementById("recentes-range");
    const recentesPageIndicator = document.getElementById("recentes-page-indicator");
    const recentesStatus = document.getElementById("recentes-status");

    recentesPageSizeSelect.addEventListener("change", () => {
      recentesPageSize = parseInt(recentesPageSizeSelect.value, 10) || 20;
      recentesPage = 1;
      loadRecentes(true);
    });

    recentesPrevBtn.addEventListener("click", () => {
      if (recentesPage > 1) {
        recentesPage--;
        loadRecentes();
      }
    });

    recentesNextBtn.addEventListener("click", () => {
      const maxPage = Math.max(1, Math.ceil(recentesTotal / recentesPageSize));
      if (recentesPage < maxPage) {
        recentesPage++;
        loadRecentes();
      }
    });

    function formatDateTime(iso) {
      if (!iso) return "-";
      try {
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return "-";
        const dia = d.toLocaleDateString("pt-BR");
        const hora = d.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
        return `${dia} ${hora}`;
      } catch {
        return iso;
      }
    }

    async function loadRecentes(forceReset = false) {
      recentesStatus.textContent = "Carregando recentes...";
      recentesStatus.classList.remove("text-red-400");
      recentesStatus.classList.add("text-slate-500");

      const from = (recentesPage - 1) * recentesPageSize;
      const to = from + recentesPageSize - 1;

      // Ordem: primeiro updated_at desc (quando existir), depois inserted_at desc
      const query = supabase
        .from("webzen_cache_raw")
        .select("*", { count: "exact" })
        .order("updated_at", { ascending: false, nullsFirst: false })
        .order("inserted_at", { ascending: false })
        .range(from, to);

      const { data, error, count } = await query;

      if (error) {
        console.error(error);
        recentesStatus.textContent = "Erro ao carregar recentes: " + (error.message || error);
        recentesStatus.classList.remove("text-slate-500");
        recentesStatus.classList.add("text-red-400");
        return;
      }

      recentesTotal = count ?? 0;
      recentesTbody.innerHTML = "";

      if (!data || data.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" class="py-3 text-center text-[11px] text-slate-500">
          Nenhum registro encontrado.
        </td>`;
        recentesTbody.appendChild(tr);
      } else {
        for (const row of data) {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-slate-800/70";
          const rawLine = (row.raw_line || "").toString();
          const tag4 = (row.tag4 || "").toString();
          const flag = row.flag ?? "";
          const online = row.online === true || row.online === 1 ? "Sim" : "Não";
          const olhar = (row.olhar || "").toString();
          const updated = row.updated_at || row.inserted_at;

          tr.innerHTML = `
            <td class="py-1.5 pr-3 align-top max-w-xs">
              <div class="truncate" title="${rawLine.replace(/"/g, "&quot;")}">
                ${rawLine || "-"}
              </div>
            </td>
            <td class="py-1.5 px-3 align-top whitespace-nowrap font-mono text-[11px]">
              ${tag4 || "-"}
            </td>
            <td class="py-1.5 px-3 align-top text-center">
              ${flag || "-"}
            </td>
            <td class="py-1.5 px-3 align-top text-center">
              ${online}
            </td>
            <td class="py-1.5 px-3 align-top max-w-[160px]">
              <div class="truncate" title="${olhar.replace(/"/g, "&quot;")}">
                ${olhar || "-"}
              </div>
            </td>
            <td class="py-1.5 px-3 align-top whitespace-nowrap">
              ${formatDateTime(updated)}
            </td>
          `;

          recentesTbody.appendChild(tr);
        }
      }

      // Atualiza textos de range + paginação
      const start = recentesTotal === 0 ? 0 : from + 1;
      const end = Math.min(recentesTotal, to + 1);
      recentesRangeSpan.textContent = `Mostrando ${start}–${end} de ${recentesTotal}`;
      recentesTotalSpan.textContent = `${recentesTotal} registros`;

      const maxPage = Math.max(1, Math.ceil(recentesTotal / recentesPageSize));
      recentesPageIndicator.textContent = `Página ${recentesPage} de ${maxPage}`;

      recentesPrevBtn.disabled = recentesPage <= 1;
      recentesNextBtn.disabled = recentesPage >= maxPage;

      recentesStatus.textContent = `Última atualização: ${formatDateTime(new Date().toISOString())}`;
    }

    // Carrega "Recentes" pelo menos uma vez se o usuário clicar na aba.
    // Se quiser carregar na inicialização, basta descomentar:
    // loadRecentes(true);
  </script>
</body>
</html>
